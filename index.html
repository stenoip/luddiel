<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lûddiel</title>
    <style>
        :root{--bg:#0e0f12;--elev-1:#14161b;--elev-2:#1a1d23;--card:#161921;--border:#232733;--text:#e6e8ee;--muted:#aab1c3;--brand:#7b5cff;--brand-2:#5fe1d6;--accent:#ff7ab6;--success:#52d67a;--warning:#ffc857;--danger:#ff6b6b;--shadow:0 8px 24px rgba(0,0,0,.25), 0 2px 6px rgba(0,0,0,.2);--radius:16px;--radius-sm:12px;--radius-xs:10px;--gap:18px;--gap-sm:12px;--gap-lg:24px;}*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 800px at -10% -10%,rgba(123,92,255,.18),transparent 40%),radial-gradient(1000px 700px at 110% -20%,rgba(95,225,214,.15),transparent 40%),var(--bg);color:var(--text);font: 15px/1.5 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";letter-spacing:.2px;}a{color:inherit;text-decoration:none}button{font:inherit}.topbar{position:sticky; top:0; z-index:50;backdrop-filter: blur(10px);background: linear-gradient(to bottom, rgba(14,15,18,.85), rgba(14,15,18,.6));border-bottom:1px solid var(--border);}.topbar-inner{display:flex; align-items:center; gap:12px;max-width:1200px; margin:0 auto; padding:14px 18px;}.brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px;background: linear-gradient(135deg, var(--brand), var(--brand-2));-webkit-background-clip:text; background-clip:text; color:transparent;font-size:22px;}.brand-badge{width:30px; height:30px; border-radius:10px;background: conic-gradient(from 200deg, var(--brand), var(--brand-2), var(--accent));box-shadow:0 0 0 2px rgba(255,255,255,.06), 0 8px 18px rgba(0,0,0,.35) inset;display:grid; place-items:center; color:white; font-size:14px; font-weight:900;}.search{flex:1; display:flex; align-items:center; gap:8px;background: var(--elev-2); border:1px solid var(--border);padding:8px 12px; border-radius:999px;}.search input{flex:1; background:transparent; border:none; outline:none; color:var(--text);}.pill{display:inline-flex; align-items:center; gap:8px;padding:9px 14px; border-radius:999px; border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));color:var(--text); cursor:pointer;transition: transform .05s ease, background .2s ease, border-color .2s ease;}.pill:hover{transform: translateY(-1px); border-color:#2e3444}.pill.primary{background: linear-gradient(135deg, rgba(123,92,255,.25), rgba(95,225,214,.22));border-color: transparent;}.file-input{display:none}.avatar{width:34px; height:34px; border-radius:50%;background: linear-gradient(135deg, #2b2f3b, #232735);border:1px solid var(--border);display:grid; place-items:center; font-weight:700; color:#c9cee1; font-size:12px;}.container{max-width:1200px; margin:20px auto; padding:0 18px;display:grid; grid-template-columns:260px minmax(0,1fr) 320px; gap:var(--gap);}.card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));border:1px solid var(--border); border-radius:var(--radius);box-shadow: var(--shadow);}.section{padding:16px}.sidebar .item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--text);border:1px solid transparent;}.sidebar .item:hover{background:var(--elev-2); border-color:var(--border)}.sidebar h3{color:#d6daea; font-size:14px; font-weight:800; letter-spacing:.4px;margin:6px 12px 8px;text-transform:uppercase;}.muted{color:var(--muted)}.tag{display:inline-flex; align-items:center; gap:8px;padding:6px 10px; border-radius:999px; border:1px solid var(--border);color:#d8dcef; background: #151823;font-size:12px;}.tag .dot{width:8px; height:8px; border-radius:50%;background: linear-gradient(135deg, var(--brand), var(--brand-2));box-shadow:0 0 0 2px rgba(123,92,255,.15);}.composer{padding:16px}.composer .row{display:flex; align-items:center; gap:12px; margin-bottom:12px;}.composer textarea{width:100%; min-height:70px; resize:vertical;background:#141823; color:var(--text); border:1px solid var(--border);border-radius:12px; padding:12px;}.chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);color:#d8dcef; background: #151823;font-size:12px;}.chip.primary{background:rgba(123,92,255,.2); border-color:var(--brand); color:#d9d3f1;}.audio-post{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:16px;}.audio-post .meta{font-size:14px; color:var(--muted); margin-bottom:10px;}.audio-post audio{width:100%;}.audio-post .actions{display:flex; justify-content:space-between; align-items:center; margin-top:12px;}.audio-post .actions .btn{padding:8px 14px;}.audio-post .stat{font-size:12px; color:var(--muted); margin-top:10px;}.comment-list{border-top:1px solid var(--border); margin-top:12px; padding-top:12px;}.comment-item{display:flex; gap:12px; margin-bottom:12px;}.comment-avatar{width:30px; height:30px; border-radius:50%;background: linear-gradient(135deg, #2b2f3b, #232735);border:1px solid var(--border);display:grid; place-items:center; font-weight:700; color:#c9cee1; font-size:12px;}.comment-body{flex:1;}.comment-author{font-weight:600;}.comment-text{font-size:14px; margin-top:4px;}.comment-form{display:flex; gap:8px; margin-top:12px;}.comment-form textarea{flex:1; background:var(--elev-1); border:1px solid var(--border); border-radius:12px; padding:8px; resize:none; color:var(--text);}.comment-form button{background:var(--brand); color:white; border:none; padding:8px 16px; border-radius:999px; cursor:pointer;}.creator{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-radius:12px; background:var(--elev-1); margin-bottom:10px;}.creator .left{display:flex; align-items:center; gap:12px;}.creator .mini{width:36px; height:36px; border-radius:50%;background: linear-gradient(135deg, #2b2f3b, #232735);border:1px solid var(--border);display:grid; place-items:center; font-weight:700; color:#c9cee1; font-size:14px;}.creator .name{font-weight:600;}.creator .muted{font-size:12px;}.creator .btn{padding:6px 12px;}.status{text-align:center; padding:10px; font-weight:600; color:var(--muted);}.status.error{color:var(--danger);}.sidebar-right .card{padding:16px;}.sidebar-right h3{font-size:16px; font-weight:700; margin-bottom:16px;}
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-inner">
            <a href="index.html" class="brand">
                <div class="brand-badge">L</div>
                Lûddiel
            </a>
            <div class="search">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="m21 21-4.35-4.35m-5.65 2.35a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" stroke="#aab1c3" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <input type="text" placeholder="Search audio, creators, tags..." />
            </div>
            <div id="auth-controls">
                </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="card">
                <div class="section">
                    <h3>Menu</h3>
                    <a href="index.html" class="item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 10h5V4H4v6zm7 10h5V4h-5v16zm7-16v16h5V4h-5z" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Home
                    </a>
                    <a href="#" class="item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18zM12 9v6m-3-3h6" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Discover
                    </a>
                    <a href="#" class="item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M16 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-8 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM5 17h14" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Following
                    </a>
                    <a href="#" class="item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 19.5v-15a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2z" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Playlists
                    </a>
                    <a href="upload.html" class="item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Upload
                    </a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="status">Loading posts...</div>
            
            <h3>Latest Audio</h3>
            <div id="latest-feed">
                </div>
        </div>

        <div class="sidebar-right">
            <div class="card">
                <div class="section">
                    <h3>Recommended for You</h3>
                    <div id="recommended-list">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://studious-space-engine-694w59x5p7r9354xv-3000.app.github.dev';
        const latestFeed = document.getElementById('latest-feed');
        const recommendedList = document.getElementById('recommended-list');
        const statusEl = document.getElementById('status');
        const authControls = document.getElementById('auth-controls');
        const authToken = localStorage.getItem('authToken');
        const userEmail = localStorage.getItem('userEmail');
        const userName = localStorage.getItem('userName');

        function createAudioPost(post) {
            const container = document.createElement('div');
            container.className = 'audio-post';
            
            const isMyPost = userName === post.userName;
            const subscribeButtonHtml = !isMyPost && authToken && !post.isSubscribed
                ? `<button class="btn ghost subscribe-btn" data-email="${post.userEmail}">+ Subscribe</button>`
                : isMyPost
                    ? `<span class="btn ghost">Your Post</span>`
                    : post.isSubscribed
                        ? `<span class="btn ghost">Subscribed</span>`
                        : '';

            container.innerHTML = `
                <div class="meta">${post.userName} — ${new Date(post.timestamp).toLocaleString()}</div>
                <audio controls src="${API_BASE}${post.file}"></audio>
                <div class="actions">
                    <button class="btn like-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12.016 2.378l.492.748c1.688 2.585 3.12 4.793 4.298 6.551 2.215 3.32 3.197 4.818 3.197 6.136 0 3.238-2.607 5.867-5.827 5.867-1.895 0-3.666-.884-4.88-2.316a.48.48 0 0 0-.742 0c-1.214 1.432-2.985 2.316-4.88 2.316-3.22 0-5.827-2.629-5.827-5.867 0-1.318.982-2.816 3.197-6.136 1.178-1.758 2.61-3.966 4.298-6.551l.492-.748c.55-.838.825-1.258 1.13-1.428.307-.17.653-.17.96 0 .307.17.582.59.13 1.428z" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span>Like (${post.likeCount})</span>
                    </button>
                    ${subscribeButtonHtml}
                </div>
                <div class="stat">Played ${post.playCount} times</div>
                
                <div class="comments-section">
                    <h4>Comments</h4>
                    <div class="comment-list"></div>
                </div>
            `;
            
            // Populate existing comments
            const commentList = container.querySelector('.comment-list');
            if (post.comments && post.comments.length > 0) {
                post.comments.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    commentItem.innerHTML = `
                        <div class="comment-avatar">${comment.userName.charAt(0).toUpperCase()}</div>
                        <div class="comment-body">
                            <div class="comment-author">${comment.userName}</div>
                            <div class="comment-text">${comment.commentText}</div>
                        </div>
                    `;
                    commentList.appendChild(commentItem);
                });
            } else {
                commentList.innerHTML = '<p class="muted">No comments yet.</p>';
            }

            const audioEl = container.querySelector('audio');
            audioEl.addEventListener('play', () => {
                fetch(`${API_BASE}/api/audio/${post.id}/play`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userEmail })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        container.querySelector('.stat').textContent = `Played ${data.newPlayCount} times`;
                    }
                })
                .catch(err => console.error("Failed to update play count", err));
            });

            const likeBtn = container.querySelector('.like-btn');
            if (!authToken) {
                likeBtn.style.display = 'none';
            } else {
                likeBtn.addEventListener('click', () => {
                    fetch(`${API_BASE}/api/audio/${post.id}/like`, { 
                        method: 'POST',
                        headers: { 'Authorization': authToken }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            likeBtn.querySelector('span').textContent = `Like (${data.newLikeCount})`;
                        } else {
                            console.error("Failed to like post", data.message);
                        }
                    })
                    .catch(err => console.error("Failed to update like count", err));
                });
            }

            const subscribeBtn = container.querySelector('.subscribe-btn');
            if(subscribeBtn) {
                subscribeBtn.addEventListener('click', async () => {
                    subscribeBtn.textContent = 'Subscribing...';
                    try {
                        const res = await fetch(`${API_BASE}/api/subscribe/${post.userEmail}`, {
                            method: 'POST',
                            headers: { 'Authorization': authToken }
                        });
                        const data = await res.json();
                        if (data.success) {
                            subscribeBtn.textContent = 'Subscribed';
                            subscribeBtn.disabled = true;
                            subscribeBtn.classList.remove('ghost');
                        } else {
                            subscribeBtn.textContent = data.message;
                            console.error(data.message);
                        }
                    } catch (err) {
                        console.error('Failed to subscribe', err);
                        subscribeBtn.textContent = 'Error';
                    }
                });
            }

            // NEW: Add comment form
            if (authToken) {
                const commentForm = document.createElement('form');
                commentForm.className = 'comment-form';
                commentForm.innerHTML = `
                    <textarea placeholder="Write a comment..." required></textarea>
                    <button type="submit">Post</button>
                `;
                container.querySelector('.comments-section').appendChild(commentForm);

                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const commentText = commentForm.querySelector('textarea').value;
                    if (!commentText.trim()) return;
                    
                    try {
                        const res = await fetch(`${API_BASE}/api/audio/${post.id}/comment`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': authToken
                            },
                            body: JSON.stringify({ commentText })
                        });
                        const data = await res.json();
                        if (data.success) {
                            commentForm.querySelector('textarea').value = '';
                            const newCommentItem = document.createElement('div');
                            newCommentItem.className = 'comment-item';
                            newCommentItem.innerHTML = `
                                <div class="comment-avatar">${userName.charAt(0).toUpperCase()}</div>
                                <div class="comment-body">
                                    <div class="comment-author">${userName}</div>
                                    <div class="comment-text">${commentText}</div>
                                </div>
                            `;
                            const noCommentsParagraph = commentList.querySelector('p.muted');
                            if (noCommentsParagraph) noCommentsParagraph.remove();
                            commentList.appendChild(newCommentItem);
                        }
                    } catch (err) {
                        console.error('Failed to post comment', err);
                    }
                });
            }

            return container;
        }

        async function loadFeeds() {
            setStatus('Loading posts...');
            try {
                // Only set the Authorization header if an authToken exists
                const headers = authToken ? { 'Authorization': authToken } : {};

                // Fetch latest posts (public, so it should work with or without a token)
                const latestRes = await fetch(`${API_BASE}/api/latest`, { headers });
                if (!latestRes.ok) throw new Error(`Latest fetch failed: ${latestRes.status}`);
                const latestPosts = await latestRes.json();
                latestFeed.innerHTML = '';
                if (latestPosts.length === 0) {
                    latestFeed.innerHTML = '<p class="muted" style="text-align:center;">No posts yet. Be the first to share!</p>';
                } else {
                    latestPosts.forEach(post => latestFeed.appendChild(createAudioPost(post)));
                }

                // Fetch recommended posts (this might be a feature for logged-in users only)
                // Check if there's an authToken before attempting this fetch.
                // If there's no token, we can't get recommendations, so we'll display a message.
                if (authToken) {
                    const recommendedRes = await fetch(`${API_BASE}/api/recommended`, { headers });
                    if (!recommendedRes.ok) throw new Error(`Recommended fetch failed: ${recommendedRes.status}`);
                    const recommendedPosts = await recommendedRes.json();
                    recommendedList.innerHTML = '';
                    if (recommendedPosts.length === 0) {
                        recommendedList.innerHTML = '<p class="muted">No recommendations yet.</p>';
                    } else {
                        recommendedPosts.forEach(post => {
                            const creatorEl = document.createElement('div');
                            creatorEl.className = 'creator';
                            creatorEl.innerHTML = `
                                <div class="left">
                                    <div class="mini">${post.userName.charAt(0).toUpperCase()}</div>
                                    <div>
                                        <div class="name">${post.userName}</div>
                                        <div class="muted" style="font-size:12px;">Likes: ${post.likeCount}</div>
                                    </div>
                                </div>
                                <a href="${API_BASE}${post.file}" download class="btn ghost">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2m-8-9v9m-4-4l4 4 4-4" stroke="#e6e8ee" stroke-width="1.6" stroke-linecap="round"/></svg>
                                </a>
                            `;
                            recommendedList.appendChild(creatorEl);
                        });
                    }
                } else {
                    // Handle the case where no user is logged in
                    recommendedList.innerHTML = '<p class="muted" style="text-align:center;">Log in to see your recommendations.</p>';
                }
                
                setStatus('');
            } catch (err) {
                console.error(err);
                setStatus('Error: ' + err.message, true);
            }
        }

        function setStatus(msg, isError = false) {
            statusEl.textContent = msg || '';
            statusEl.className = 'status' + (isError ? ' error' : '');
        }

        function setupAuthControls() {
            if (authToken) {
                authControls.innerHTML = `
                    <div class="avatar" title="${userEmail}">${userName.charAt(0).toUpperCase()}</div>
                    <button class="pill" id="logout-btn">Log Out</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    window.location.reload();
                });
            } else {
                authControls.innerHTML = `
                    <a href="login.html" class="pill">Login</a>
                    <a href="register.html" class="pill primary">Sign Up</a>
                `;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            setupAuthControls();
            loadFeeds();
        });
    </script>
</body>
</html>
