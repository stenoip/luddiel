<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lûddiele — share audio & videos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Dark theme base */
    :root {
      color-scheme: dark;
      --bg: #1f1f1f;
      --panel: #2a2a2a;
      --muted: #a7a7a7;
      --text: #eaeaea;
      --accent: #7aa2ff;
      --danger: #ff6565;
      --border: #3b3b3b;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 0; }
    header h1 { margin: 0; font-size: 20px; letter-spacing: .3px; }
    header small { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; }
    .pad { padding: 14px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .row > * { flex: 1 1 240px; min-width: 220px; }
    label { font-size: 13px; color: var(--muted); display:block; margin-bottom:6px; }
    input[type="text"], input[type="file"], textarea, button { background:#242424; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 12px; font:inherit; }
    button { cursor:pointer; }
    button.primary { background: var(--accent); color: #0e1427; border:0; }
    button.ghost { background: transparent; }
    .inline { display:flex; align-items:center; gap:8px; }
    .spacer { height: 16px; }
    .muted { color: var(--muted); }
    .pill { padding: 3px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color: var(--muted); }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:12px; }
    .post { overflow:hidden; border-radius:8px; border:1px solid var(--border); background:#262626; }
    .post .thumb { position:relative; aspect-ratio:16/9; background:#1a1a1a; display:grid; place-items:center; }
    .post .body { padding: 10px; display:grid; gap: 8px; }
    .actions { display:flex; gap:8px; align-items:center; }
    .actions button { padding:6px 10px; font-size:14px; }
    .img-responsive { width: 100%; }

    /* Your CSS converted to valid CSS (kept functionally identical) */
    .modal { background-color: rgba(0,0,0,0.4); position: fixed; inset: 0; display: none; align-items:center; justify-content:center; z-index: 999; }
    .modal.open { display: flex; }
    .modal-header { border-bottom: 1px solid #505050; padding: 12px 16px 6px 16px; display:flex; align-items:center; justify-content:space-between; }
    .modal-header .modal-title { color: #ccc; margin: 0; }
    .modal-header .close { font-size: 32px; opacity: 1.0; color: #ccc; text-shadow: none; outline: none; background: transparent; border: 0; cursor: pointer; }
    .modal-content { border-radius: 0; border: 0; background-color: #323232; max-width: 920px; width: calc(100% - 24px); }
    button.btn-play { position: absolute; top: 0; bottom: 0; padding: 0; margin: 0; margin-left: -15px; border: 0; border-radius: 0; outline: 0 !important; width: 100%; background-color: transparent; color: rgba(245, 245, 245, 0.8); display:grid; place-items:center; }
    button.btn-play:hover, button.btn-play:active, button.btn-play:visited, button.btn-play:focus { color: rgba(255, 255, 255, 1.0); }
    button.btn-play .glyphicon { padding: 0; margin: 0; color: inherit; background-color: inherit; font-size: 64px; }
    @media (min-width: 992px) and (max-width: 1199px) { button.btn-play .glyphicon { font-size: 56px; } }
    @media (min-width: 768px) and (max-width: 991px) { button.btn-play .glyphicon { font-size: 46px; } }
    @media (max-width: 767px) { a.video { display:block; } button.btn-play .glyphicon { font-size: 56px; } }

    /* Modal body */
    .modal-body { padding: 12px 16px 16px 16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Lûddiele</h1>
        <small class="muted">“Loo-dee-eh-luh” — share sound and motion</small>
      </div>
      <div class="inline">
        <span class="pill" id="session-pill">guest</span>
        <button class="ghost" id="signin-btn">Set display name</button>
      </div>
    </header>

    <div class="card pad">
      <div class="row">
        <div>
          <label for="displayName">Display name</label>
          <input id="displayName" type="text" placeholder="FryskFan" />
        </div>
        <div>
          <label for="caption">Caption</label>
          <input id="caption" type="text" placeholder="A morning soundwalk in Brooklyn" />
        </div>
        <div>
          <label for="file">Media file (mp4/webm/mov/mp3/wav)</label>
          <input id="file" type="file" accept="video/*,audio/*" />
        </div>
      </div>
      <div class="spacer"></div>
      <div class="inline">
        <button class="primary" id="uploadBtn">Upload & post</button>
        <span id="uploadStatus" class="muted"></span>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card pad">
      <div class="inline" style="justify-content: space-between;">
        <h3 style="margin: 0;">Feed</h3>
        <button id="refreshBtn" class="ghost">Refresh</button>
      </div>
      <div class="spacer"></div>
      <div id="feed" class="list"></div>
    </div>

    <div class="spacer"></div>
    <div class="muted" style="text-align:center; font-size:12px;">© Stenoip Company</div>
  </div>

  <!-- Modal viewer -->
  <div class="modal" id="viewer">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="viewerTitle">Playing…</div>
        <button class="close" id="closeViewer" aria-label="Close viewer">&times;</button>
      </div>
      <div class="modal-body">
        <div id="viewerMedia" class="img-responsive"></div>
      </div>
    </div>
  </div>

  <script>
    // Set this to your deployed Vercel URL (no trailing slash)
    const API_BASE = 'https://YOUR-VERCEL-APP.vercel.app';

    // Very light "auth": persistent session id + display name
    const session = {
      id: localStorage.getItem('lud_sess_id') || crypto.randomUUID(),
      name: localStorage.getItem('lud_name') || 'guest'
    };
    localStorage.setItem('lud_sess_id', session.id);
    document.getElementById('displayName').value = session.name;
    document.getElementById('session-pill').textContent = session.name;

    document.getElementById('signin-btn').addEventListener('click', () => {
      const name = prompt('Choose a display name:')?.trim();
      if (!name) return;
      session.name = name.slice(0, 64);
      localStorage.setItem('lud_name', session.name);
      document.getElementById('displayName').value = session.name;
      document.getElementById('session-pill').textContent = session.name;
    });

    // Upload & create post
    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const status = document.getElementById('uploadStatus');
      status.textContent = '';
      try {
        const fileEl = document.getElementById('file');
        if (!fileEl.files.length) return alert('Pick a media file first.');
        const file = fileEl.files[0];

        const caption = document.getElementById('caption').value.trim();
        const author = document.getElementById('displayName').value.trim() || 'guest';

        status.textContent = 'Requesting upload URL…';
        const upRes = await fetch(API_BASE + '/api/create-upload-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: file.name, contentType: file.type })
        });
        if (!upRes.ok) throw new Error('Could not get upload URL');
        const { uploadUrl, blobUrl } = await upRes.json();

        status.textContent = 'Uploading media…';
        const fd = new FormData();
        fd.append('file', file);
        const blobRes = await fetch(uploadUrl, { method: 'POST', body: fd });
        if (!blobRes.ok) throw new Error('Upload failed');

        status.textContent = 'Creating post…';
        const create = await fetch(API_BASE + '/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: session.id,
            author,
            caption,
            mediaUrl: blobUrl,
            mediaType: file.type
          })
        });
        if (!create.ok) throw new Error('Post creation failed');

        document.getElementById('caption').value = '';
        fileEl.value = '';
        status.textContent = 'Posted!';
        await loadFeed();
        setTimeout(() => status.textContent = '', 1200);
      } catch (e) {
        console.error(e);
        document.getElementById('uploadStatus').textContent = 'Error: ' + e.message;
      }
    });

    // Feed rendering
    const feedEl = document.getElementById('feed');
    document.getElementById('refreshBtn').addEventListener('click', loadFeed);

    async function loadFeed() {
      feedEl.innerHTML = '<div class="muted">Loading…</div>';
      const res = await fetch(API_BASE + '/api/feed');
      const data = await res.json();
      feedEl.innerHTML = '';
      data.posts.forEach(renderPost);
    }

    function renderPost(p) {
      const card = document.createElement('div');
      card.className = 'post';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const play = document.createElement('button');
      play.className = 'btn-play';
      const icon = document.createElement('span');
      icon.className = 'glyphicon';
      icon.textContent = '▶';
      play.appendChild(icon);
      play.addEventListener('click', () => openViewer(p));

      thumb.appendChild(play);

      const body = document.createElement('div');
      body.className = 'body';

      const title = document.createElement('div');
      title.textContent = p.caption || '(no caption)';

      const meta = document.createElement('div');
      meta.className = 'muted';
      meta.textContent = `${p.author} • ${new Date(p.created_at).toLocaleString()}`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const likeBtn = document.createElement('button');
      likeBtn.className = 'ghost';
      likeBtn.textContent = `❤ ${p.likes_count}`;
      likeBtn.addEventListener('click', async () => {
        await fetch(API_BASE + '/api/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId: p.id, sessionId: session.id })
        });
        await loadFeed();
      });

      const commentInput = document.createElement('input');
      commentInput.placeholder = 'Write a comment…';
      commentInput.style.flex = '1';

      const commentBtn = document.createElement('button');
      commentBtn.textContent = 'Comment';
      commentBtn.className = 'ghost';
      commentBtn.addEventListener('click', async () => {
        const text = commentInput.value.trim();
        if (!text) return;
        await fetch(API_BASE + '/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ postId: p.id, author: session.name, text })
        });
        commentInput.value = '';
        await loadFeed();
      });

      const comments = document.createElement('div');
      comments.className = 'muted';
      comments.style.fontSize = '13px';
      comments.innerHTML = (p.comments || []).map(c => {
        const when = new Date(c.created_at).toLocaleString();
        return `<div><strong>${c.author}</strong>: ${c.text} <span class="muted">• ${when}</span></div>`;
      }).join('');

      actions.appendChild(likeBtn);
      actions.appendChild(commentInput);
      actions.appendChild(commentBtn);

      body.appendChild(title);
      body.appendChild(meta);
      body.appendChild(actions);
      body.appendChild(comments);

      card.appendChild(thumb);
      card.appendChild(body);
      feedEl.appendChild(card);
    }

    // Modal viewer
    const viewer = document.getElementById('viewer');
    const viewerTitle = document.getElementById('viewerTitle');
    const viewerMedia = document.getElementById('viewerMedia');
    document.getElementById('closeViewer').addEventListener('click', closeViewer);
    viewer.addEventListener('click', (e) => { if (e.target === viewer) closeViewer(); });

    function openViewer(post) {
      viewerTitle.textContent = post.caption || '(no caption)';
      viewerMedia.innerHTML = '';
      const isAudio = (post.media_type || '').startsWith('audio/');
      if (isAudio) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = post.media_url;
        audio.style.width = '100%';
        viewerMedia.appendChild(audio);
      } else {
        const video = document.createElement('video');
        video.controls = true;
        video.src = post.media_url;
        video.style.width = '100%';
        viewerMedia.appendChild(video);
      }
      viewer.classList.add('open');
    }
    function closeViewer() {
      viewer.classList.remove('open');
      viewerMedia.innerHTML = '';
    }

    // Initial load
    loadFeed();
  </script>
</body>
</html>
